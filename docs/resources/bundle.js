(()=>{"use strict";const e="color",t="brush",s="pencil",i="eraser",n="undo",o="save",r="clear",a="preview",l=[e,t,s,i,n,o,r,a];class c{constructor(e){this.label=e}log(e){console.log(`[${this.label}] ${(new Date).toISOString()} ðŸ —ðŸ —ðŸ —ðŸ —ðŸ —`),console.log(e)}}new c("Debug");let h=new c("Error");class d{constructor(e,t){this.type=e,this.data=t,Object.freeze(this)}}class u{constructor(){this.listener={}}addEventListener(e,t){void 0===this.listener[e]&&(this.listener[e]=[]),this.listener[e].push(t)}notifyAll(e){if(void 0!==this.listener[e.type])for(let t=0;t<this.listener[e.type].length;t++)this.listener[e.type][t](e)}}class m extends d{constructor(e){super("action",{actionType:e.type})}}class v extends u{constructor(e){super(),this.el=e,this.items=e.querySelectorAll("li"),this.items.forEach((e=>{e.addEventListener("click",(e=>this.onItemSelected(e)))}))}onItemSelected(e){let t=e.target.getAttribute("data-item");try{let e=new class{constructor(e){if(!l.includes(e))throw`Can not construct unkown action: ${e}`;this.type=e,Object.freeze(this)}}(t),s=new m(e);this.notifyAll(s)}catch(e){h.log(e)}}}class g extends v{constructor(e){super(e)}setSelectedColor(e){Array.from(this.items).find((e=>"color"===e.getAttribute("data-item"))).className=`item icon-color ${e}-selector`}setSelectedTool(e){this.items.forEach((t=>{t.getAttribute("data-item")!==e?t.classList.remove("active"):t.classList.add("active")}))}}class p{constructor(e,t){this.type=e,t.forEach((e=>{this[e.name]=e.value})),Object.freeze(this)}getRepresentation(){return{type:this.type,size:this.lineWidth||this.radius,lineCap:this.lineCap,lineJoin:this.lineJoin}}}let f=new p("brush",[{name:"lineCap",value:"round"},{name:"lineJoin",value:"round"},{name:"lineWidth",value:10}]),y=new p("pencil",[{name:"lineCap",value:"round"},{name:"lineJoin",value:"round"},{name:"lineWidth",value:5}]),w=new p("eraser",[{name:"radius",value:10}]);const x=[];class C{constructor(e,t){this.name=e,this.red=t[0],this.green=t[1],this.blue=t[2],Object.freeze(this)}toCSS(){return`rgb(${this.red}, ${this.green}, ${this.blue})`}next(){let e=x.findIndex((e=>e.name===this.name))+1;return e>x.length-1&&(e=0),x[e]}}x.push(new C("green",[9,85,34])),x.push(new C("yellow",[245,162,42])),x.push(new C("red",[219,40,42])),x.push(new C("cream",[255,220,206])),x.push(new C("blue",[132,204,186])),x.push(new C("gold",[255,198,77]));class S extends d{constructor(e){super("modelChanged",function(e){return{tool:e.tool.getRepresentation(),color:{name:e.color.name,css:e.color.toCSS()}}}(e))}}const b=class extends u{constructor(){super()}init(){this.color=x[0],this.tool=f,this.notifyAll(new S(this))}setTool(e){this.tool=e,this.notifyAll(new S(this))}shiftColor(){this.color=this.color.next(),this.notifyAll(new S(this))}};class F{constructor(e,t){this.context=e,this.precondition=this.context.getImageData(0,0,this.context.canvas.width,this.context.canvas.height),this.model=t}undo(){this.context.putImageData(this.precondition,0,0)}apply(){throw new Error("Not implemented")}smash(e){this.precondition=e.precondition}}class L extends F{constructor(e,t,s,i){super(e,t),this.from=s,this.to=i}apply(){this.context.beginPath(),this.context.moveTo(this.from.x,this.from.y),this.context.lineTo(this.to.x,this.to.y),this.context.strokeStyle=this.model.color.css,this.context.lineCap=this.model.tool.lineCap,this.context.lineJoin=this.model.tool.lineJoin,this.context.lineWidth=this.model.tool.size,this.context.stroke(),this.context.closePath()}}class E extends F{constructor(e,t,s){super(e,t),this.at=s}apply(){this.context.save(),this.context.beginPath(),this.context.fillStyle="#FFF",this.context.arc(this.at.x,this.at.y,this.model.tool.size,0,2*Math.PI,!0),this.context.fill(),this.context.closePath(),this.context.restore()}}class I extends F{apply(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)}}class k extends F{constructor(e,t,s){super(e,t),this.color=s}apply(){this.context.save(),this.context.beginPath(),this.context.fillStyle=this.color,this.context.fillRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.closePath(),this.context.restore()}}let q,A=[],D=!1,M=!0;class P extends d{constructor(){super("historyChanged")}}function R(e,t){return{x:e.clientX-t.offsetLeft,y:e.clientY-t.offsetTop}}function T(e){e.apply(),M?(A.push(e),M=!1):(e.smash(A[A.length-1]),A[A.length-1]=e)}const $=class extends u{constructor(e){super(),this.canvas=e,this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight,this.context=this.canvas.getContext("2d"),this.canvas.addEventListener("mousemove",(e=>this.onMouseMovedInCanvas(e))),this.canvas.addEventListener("mousedown",(e=>this.onMousePressedDownInCanvas(e))),this.canvas.addEventListener("mouseup",(e=>this.onMouseReleasedInCanvas(e))),this.canvas.addEventListener("mouseleave",(e=>this.onMouseLeftCanvas(e))),T(new k(this.context,this.model,"#FFF"))}setModel(e){this.model=e}getImageAsDataURL(){return this.canvas.toDataURL()}undo(){A.length<1||(A.pop().undo(),this.notifyAll(new P))}clear(){T(new I(this.context,this.model)),T(new k(this.context,this.model,"#FFF"))}onMouseMovedInCanvas(e){let t,s;D&&(void 0!==q?(s=R(e,this.canvas),t=function(e,t,s,i){return t.tool.type===f.type||t.tool.type===y.type?new L(e,t,i,s):t.tool.type===w.type?new E(e,t,s):void 0}(this.context,this.model,s,q),T(t),q=s):q=R(e,this.canvas))}onMousePressedDownInCanvas(){D=!0}onMouseReleasedInCanvas(){D=!1,M=!0,q=void 0}onMouseLeftCanvas(){D=!1,M=!0,q=void 0}},W=class extends u{constructor(e){super(),this.model=new b,this.model.addEventListener("modelChanged",this.onModelChanged.bind(this)),this.controller=new $(e),this.model.init()}onModelChanged(e){this.controller.setModel(e.data),this.notifyAll(e)}undo(){this.controller.undo()}clear(){this.controller.clear()}getImage(){return new Promise(((e,t)=>{let s=this.controller.getImageAsDataURL(),i=new Image;i.onload=()=>e(i),i.onerror=()=>t(),i.src=s}))}useBrush(){this.model.setTool(f)}usePencil(){this.model.setTool(y)}useEraser(){this.model.setTool(w)}changeColor(){this.model.shiftColor()}};let j;class z extends d{constructor(e){super("gifCreated",e)}}class B{constructor(e,t=100){this.id=new class{constructor(){this.id=(j?j+=1:j=Date.now(),j),Object.freeze(this)}asString(){return this.id.toString()}equals(e){return this.id===e.id}},this.image=e,this.delay=t}}const G=class extends u{constructor(){super(),this.frames=[]}addFrameFromImage(e){let t=new B(e);return this.frames.push(t),this.render(),t}removeFrameWithId(e){let t=this.frames.findIndex((t=>t.id.equals(e))),s=this.frames.splice(t,1)[0];return this.render(),s}setDelayForFrameWithId(e,t){let s=this.frames.find((t=>t.id.equals(e)));return s.delay=t,this.render(),s}getCurrentGif(){return this.gif}render(){var e;0!==this.frames.length&&(e=this.frames,new Promise((function(t,s){let i;i=new GIF({workers:2,workerScript:"vendors/gif.js/gif.worker.js",width:e[0].image.width,height:e[0].image.height,quality:10}),e.forEach((e=>i.addFrame(e.image,{delay:e.delay}))),i.on("finished",(e=>t(URL.createObjectURL(e)))),i.on("abort",(()=>s())),i.render()}))).then((e=>{this.gif=e,this.notifyAll(new z(e))}))}},O=document.querySelector("#frame-template").innerHTML.trim();class J extends d{constructor(e){super("removeFrameButtonClicked",{id:e})}}class U extends d{constructor(e,t){super("frameDelaySelected",{id:e,delay:t})}}function H(e,t){let s=document.createElement("div");return s.innerHTML=O,s=s.firstChild,s.setAttribute("data-id",t.id.asString()),s.querySelector("img").src=t.image.src,s.querySelector(`.time-selector [data-delay="${t.delay}"]`).classList.add("selected"),s.querySelector(".trash").addEventListener("click",N.bind(e,t.id)),s.querySelector(".time-selector").addEventListener("click",X.bind(e,t.id)),s}function N(e){this.notifyAll(new J(e))}function X(e,t){t.target.classList.contains("time")&&this.notifyAll(new U(e,t.target.getAttribute("data-delay")))}const Y=class extends u{constructor(e){super(),this.el=e}addFrame(e){let t=H(this,e);this.el.append(t)}updateFrame(e){let t=this.el.querySelector(`[data-id="${e.id.asString()}"]`);t.querySelector("img").src=e.image.src,t.querySelector(".time-selector .selected").classList.remove("selected"),t.querySelector(`.time-selector [data-delay="${e.delay}"]`).classList.add("selected")}removeFrame(e){this.el.querySelector(`[data-id="${e.id.asString()}"]`).remove()}};let K,Q,V,Z;function _(e){V.setSelectedColor(e.data.color.name),V.setSelectedTool(e.data.tool.type)}function ee(l){switch(l.data.actionType){case e:K.changeColor();break;case t:K.useBrush();break;case s:K.usePencil();break;case i:K.useEraser();break;case n:K.undo();break;case o:K.getImage().then((e=>Z.addFrame(e)));break;case r:K.clear();break;case a:Z.togglePreview()}}!function(){let e=document.querySelector("canvas");K=new W(e),K.addEventListener("modelChanged",_)}(),function(){let e=document.querySelector(".actions"),t=document.querySelector(".toolbar");Q=new v(e),Q.addEventListener("action",ee),V=new g(t),V.addEventListener("action",ee)}(),function(){let e=document.querySelector(".timeline .frames"),t=document.querySelector(".preview");Z=new class{constructor(e,t){this.creator=new G,this.creator.addEventListener("gifCreated",(e=>this.onGifCreated(e))),this.timeline=new Y(e),this.timeline.addEventListener("removeFrameButtonClicked",(e=>this.onRemoveFrameButtonClicked(e))),this.timeline.addEventListener("frameDelaySelected",(e=>this.onFrameDelaySelected(e))),this.previewEl=t,this.previewEl.querySelector(".download").addEventListener("click",(()=>this.onDownloadGifButtonClicked()))}addFrame(e){let t=this.creator.addFrameFromImage(e);this.timeline.addFrame(t)}togglePreview(){this.previewEl.classList.toggle("hidden")}onGifCreated(e){this.previewEl.querySelector("img").src=e.data}onRemoveFrameButtonClicked(e){let t=this.creator.removeFrameWithId(e.data.id);this.timeline.removeFrame(t)}onFrameDelaySelected(e){let t=this.creator.setDelayForFrameWithId(e.data.id,e.data.delay);this.timeline.updateFrame(t)}onDownloadGifButtonClicked(){var e=document.createElement("a");e.href=this.creator.getCurrentGif(),e.download="ChristmasCard.gif",e.click()}}(e,t)}()})();